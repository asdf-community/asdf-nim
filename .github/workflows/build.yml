name: Build
on:
  pull_request:
    paths-ignore:
      - README.md
  push:
    paths-ignore:
      - README.md

jobs:
  test:
    name: asdf-nim plugin test
    strategy:
      fail-fast: false
      matrix:
        include:
          # Test installation of official Linux binaries from nim-lang.org
          - os: ubuntu-latest
            nim-version: 1.4.2
          - os: ubuntu-latest
            nim-version: 1.2.8
          - os: ubuntu-latest
            nim-version: 1.0.10
          - os: ubuntu-latest
            nim-version: 0.20.2

          # Test building from git checkout
          - os: ubuntu-latest
            nim-version: ref:876fa3e62e41cd366b89137cc3c4f6b5b8b2bee8

          # 2020-01-01 - macOS builds across repos on Github Actions are timing out, so disabling for now
          ## Test installation of unoffical macOS binaries from elijahr/nim-builds
          # - os: macos-latest
          #   nim-version: 1.4.2

    runs-on: ${{ matrix.os }}
    steps:
      - name: Test nimble ${{ matrix.nim-version }}
        uses: asdf-vm/actions/plugin-test@v1
        with:
          command: nim -v
          github_token: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ matrix.nim-version }}

  # TODO - replace below with Bats tests
  assert_nimble_configuration:
    name: assert that nimble is configured correctly
    runs-on: ubuntu-latest
    steps:
      - name: Install asdf
        uses: asdf-vm/actions/setup@v1
      - name: Checkout repo
        uses: actions/checkout@v2
      - name:
        shell: bash
        run: |
          set -uex

          asdf plugin add nim .
          asdf install nim 1.4.2
          asdf local nim 1.4.2

          ASDF_INSTALL_PATH="${HOME}/.asdf/installs/nim/1.4.2"

          # Assert package index is placed in the correct location
          nimble refresh -y
          test -f "${ASDF_INSTALL_PATH}/nimble/packages_official.json"

          # Assert package installs to correct location
          nimble install -y nimjson@1.2.8
          test -x "${ASDF_INSTALL_PATH}/nimble/bin/nimjson"
          test -f "${ASDF_INSTALL_PATH}/nimble/pkgs/nimjson-1.2.8/nimjson.nimble"

          # Assert that shim was created for package binary
          test "$(which nimjson)" != ""

          # Assert that nim finds nimble packages
          echo "import nimjson" >test.nim
          nim c -r test.nim

  assert_multiple_nims:
    name: assert that multiple nims can be installed side-by-side
    runs-on: ubuntu-latest
    steps:
      - name: Install asdf
        uses: asdf-vm/actions/setup@v1
      - name: Checkout repo
        uses: actions/checkout@v2
      - name: Install binary Nim 1.4.2
        run: |
          asdf plugin add nim .
          asdf install nim 1.4.2
      - name: Build Nim HEAD
        run: |
          # Building from source will bootstrap with the existing nim
          asdf install nim ref:HEAD
