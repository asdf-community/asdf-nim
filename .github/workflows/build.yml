# yamllint disable rule:line-length

name: build

# yamllint disable rule:truthy
on:
  # yamllint enable rule:truthy
  workflow_dispatch: {}
  pull_request:
    branches: ["*"]
    paths:
      - .github/workflows/build.yml # changes to this file
      - bin/** # changes to asdf entrypoint scripts
      - lib/** # changes to library functions
      - share/** # changes to data files
      - shims/** # changes to shim scripts
      - test/** # changes to tests
      - package*.json # bats upgrade
  push:
    branches: ["main"]
    tags: ["*"]
    paths:
      - .github/workflows/build.yml # changes to this file
      - bin/** # changes to asdf entrypoint scripts
      - lib/** # changes to library functions
      - share/** # changes to data files
      - shims/** # changes to shim scripts
      - test/** # changes to tests
      - package*.json # bats upgrade

jobs:
  # Run tests with bats
  bats_tests:
    name: Bats tests
    runs-on: ubuntu-latest

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout plugin
        uses: actions/checkout@v5

      - uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Install Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.24.9"

      - name: Cache test dependencies
        uses: actions/cache@v4
        with:
          path: .test-cache
          key: test-cache-${{ runner.os }}-asdf-v0.18.0-nim-ref-version-2-2
          restore-keys: |
            test-cache-${{ runner.os }}-asdf-v0.18.0-

      - name: Run tests
        run: |
          npm install --include=dev
          [ -n "$(which bats)" ] || npm link bats
          npm run test -- --jobs 4

  plugin_test_x86:
    name: ðŸ‘‘${{ matrix.nim-version }}/${{ matrix.platform }}/x86_64
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # Stable binary
          - os: ubuntu-latest
            nim-version: "latest:1.6"
            platform: linux

          # Stable binary
          - os: ubuntu-latest
            nim-version: "latest:2.2"
            platform: linux

          # Unstable binary
          - os: ubuntu-latest
            nim-version: "ref:version-2-0"
            platform: linux

          # Unstable binary
          - os: macos-latest
            nim-version: "ref:devel"
            platform: macOS

          # Build from source
          - os: ubuntu-latest
            nim-version: "ref:HEAD"
            platform: linux

          # Build from source
          - os: macos-latest
            asdf_nim_no_nightly_fallback: 1
            nim-version: "latest:2.2"
            platform: macOS

    steps:
      # Optimization: re-use cached Nim->C compilation
      - name: Restore cache
        if: matrix.nim-version != 'ref:HEAD' && matrix.nim-version != 'latest'
        uses: actions/cache@v4
        with:
          path: ~/.cache
          key: cache-${{ matrix.os }}-${{ matrix.nim-version }}

      - name: Set environment variables
        if: ${{ matrix.asdf_nim_no_nightly_fallback }}
        run: |
          echo "ASDF_NIM_NO_NIGHTLY_FALLBACK=${{ matrix.asdf_nim_no_nightly_fallback }}" >> $GITHUB_ENV

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install bash parallel golang

      - name: Install dependencies (Linux)
        if: runner.os != 'macOS'
        uses: actions/setup-go@v6
        with:
          go-version: "1.24.9"

      - name: Install asdf
        run: go install github.com/asdf-vm/asdf/cmd/asdf@master

      - name: Checkout plugin
        uses: actions/checkout@v5

      - name: Test plugin
        shell: bash
        run: |
          exec ./scripts/ci-test-plugin.sh \
            --nim-version ${{ matrix.nim-version }}

  # Test on Alpine Linux (musl)
  plugin_test_x86_musl:
    name: ðŸ‘‘2.2.x/linux-alpine/x86_64
    runs-on: ubuntu-latest
    container: alpine:latest

    steps:
      # Optimization: re-use cached Nim->C compilation
      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: ~/.cache
          key: cache-ubuntu-latest-2.2.4

      - name: Install dependencies
        run: apk add --update --no-cache --upgrade bash git curl coreutils tar xz grep build-base go

      - name: Install asdf
        run: go install github.com/asdf-vm/asdf/cmd/asdf@master

      - name: Checkout plugin
        uses: actions/checkout@v5

      - name: Test plugin
        shell: bash
        run: |
          exec ./scripts/ci-test-plugin.sh \
            --nim-version latest:2.2

  # Test installation for a few non-x86 architectures
  plugin_test_non_x86:
    name: ðŸ‘‘${{ matrix.nim-version }}/linux/${{ matrix.arch }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # Unstable binary
          - runs-on: ubuntu-latest
            nim-version: "ref:version-2-2"
            arch: aarch64

          # Unstable binary
          - runs-on: ubuntu-latest
            nim-version: "ref:version-1-6"
            arch: armv7

    steps:
      # Optimization: re-use cached Nim->C compilation
      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: ~/.cache
          key: cache-${{ matrix.arch }}-${{ matrix.nim-version }}

      - name: Checkout plugin
        uses: actions/checkout@v5

      # Install & run tests on non-x86
      - uses: uraimo/run-on-arch-action@v3
        name: Test plugin
        with:
          arch: ${{ matrix.arch }}
          distro: bookworm
          dockerRunArgs: |
            --volume "${HOME}/.cache:/root/.cache"
            --volume "${GITHUB_WORKSPACE}:/workspace"
          shell: /usr/bin/env bash
          setup: |
            mkdir -p "${HOME}/.cache"
          run: |
            set -uexo pipefail
            cd /workspace
            ./scripts/ci-install.sh
            exec ./scripts/ci-test-plugin.sh \
              --nim-version ${{ matrix.nim-version }}
