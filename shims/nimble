#!/usr/bin/env bash

set -ueo pipefail

ASDF_BIN="${ASDF_DATA_DIR:-$ASDF_DIR}/bin/"
ASDF_INSTALL_PATH="$("${ASDF_BIN}/asdf" where nim)"

regenerate() {
  # After a nimble operation, regenerate nim shims to find new package binaries
  (
    "${ASDF_BIN}/asdf" reshim nim
  ) && (
    echo "  asdf-nim: regenerated shims"
  ) || (
    echo "  asdf-nim: failed to regenerate shims"
    exit 1
  )
  echo
}

trap 'trap - HUP; SIGNAL=SIGHUP; regenerate; kill -HUP $$' HUP
trap 'trap - INT; SIGNAL=SIGINT; regenerate; kill -INT $$' INT
trap 'trap - TERM; SIGNAL=SIGTERM; regenerate; kill -TERM $$' TERM

status=0
(
  "${ASDF_INSTALL_PATH}/bin/nimble" "$@"
) && (
  status=$?
  case "$1" in
    install | develop | uninstall)
      regenerate
      ;;
  esac
) || (
  status=$?
)
exit $status
